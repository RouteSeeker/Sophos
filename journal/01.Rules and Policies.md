# Sophos Firewall Lab 01: Rules, Policies, DHCP, and DNS

Hi there,  

This is the first entry in my new Sophos Firewall series where I will be testing out next generation firewall features hands-on. Having the opportunity to get a Sophos trial license is amazing, so I am taking full advantage to explore as many features as possible.  

This initial lab focuses on the basics: setting up rules and policies, enabling DHCP, and configuring DNS. These foundational steps make it possible to test and validate more advanced features in later labs.  

---

## Lab Setup

I set up the Sophos Firewall with three interfaces:  

- **PortA**: LAN (10.1.1.0/24)  
- **PortB**: WAN (192.168.10.0/24)  
- **PortC**: DMZ (172.16.0.0/24)  

I also connected two PCs (LAB-PC1 and LAB-PC2). An Active Directory server  and DMZ will come in later labs.  

![Topology](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/01.Topology.png)

---

## Step 1: Static IP Setup

I configured static IP addresses for the three firewall ports:  

- PortA: 10.1.1.200/24 (LAN)  
- PortB: 192.168.10.200/24 (WAN)  
- PortC: 172.16.0.200/24 (DMZ)  

![Sophos IP](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/02.Network_settings.png)

On the PCs I assigned:  

- LAB-PC1: 10.1.1.153

![PC1](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/03.Windows_IP%20address_PC1.png)

- LAB-PC2: 10.1.1.151 

![PC2](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/04.Windows_IP_Address_PC2.png)

---

## Step 2: Hosts and Services

I added the two PC addresses under **Hosts and Services**.  

By defining hosts explicitly, Sophos can use them in firewall rules and policies. This also makes policy creation clearer and avoids errors later. 

![host and services](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/05.Host%20and%20Services%20Add.png)

![Adding PC1](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/06.Adding%20PC1%20Host.png)

![Adding PC2](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/07.Adding%20PC2%20Host.png)

I then created a host group and added only one registered PC to it.  

(Host groups allow us to apply rules to sets of machines easily. This will help us test enforcement by including or excluding PCs.

![Host group](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/08.Creating%20host%20group.png)

![adding PC to host group](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/09.Adding_PC%20to%20host%20group.png)

---

## Step 3: LAN-to-WAN Firewall Rule

On the **Rules and Policies** tab I created a new firewall rule named **LAN-to-WAN**.  

![Creating FW Rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/10.Creating_Firewall_Rule.png)

Settings:  
- Enabled the rule and moved it to the top.  
- Checked **Log traffic** for visibility.  

**Source Section:**  
- Source Zone: LAN  
- Source Networks/Devices: LAB-PC1 and LAB-PC2  
- Schedule: All the time  

![Rule Name](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/11.Rule_Name%20creation.png)

**Destination Section:**  
- Destination Zone: WAN  
- Destination Networks: Any  
- Services: Any (initially allowing all traffic to test connectivity)  

![Destination](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/12.Destination%20and%20services.png)

**Linked NAT Rule:**  
- Translated Source (SNAT): MASQ  

MASQ, or masquerading, hides internal IPs behind the firewall’s public IP. This is standard practice for outbound internet access.

![NAT](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/13.Natting.png)

![MASQ](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/14.MASQ%20setup.png)

Saved the rule.  

![Finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/15.finishint%20rules%20and%20policies.png)

---

## Step 4: Ping and DNS Test

On a PC I pinged **8.8.8.8** and received a response, proving connectivity.  

![Ping testt](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/16.ping_works.png)

However, browsing failed because DNS was not configured.  

![Browser Check](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/17.Browsing_doesn't.png)

After manually setting DNS servers, browsing worked.  

![DNS Setting](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/18.DNS%20Manual%20setup.png)

![Browser Check again](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/19.Browse_Check.png)

---

## Step 5: Rule Enforcement Test

I removed LAB-PC1 from the **Source Networks and Devices** in the rule, leaving only LAB-PC2.  

![Remove PC1](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/20.Removing%20PC1.png)

On LAB-PC1 I tried pinging again and was blocked.  

This shows that firewall rules precisely enforce who is allowed to pass traffic, which is the foundation of security.)  

![Can't browse](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/21.Can't%20ping%20or%20browse.png)

---

## Step 6: Destination Networks Test

I configured the rule to allow only **YouTube** as the destination.  

![Youtube](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/22.youtube%20only.png)

On the PC I was able to reach YouTube.  

![Youtube works](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/23.only%20youtube%20works.png)

When I tried Google, access was denied.  

Destination control is powerful for enforcing acceptable use policies. It demonstrates application-level filtering capability.

![Google fails](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/24.Google%20fails.png)

---

## Step 7: Services Test

To enforce more granular control, I limited services to **DNS, HTTP, HTTPS, and ICMP**.  

![Other test](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/25.Other%20services%20test.png)

![Other test check](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/26.services%20test%20check.png)

These are essential protocols for normal web use. Restricting services reduces attack surface and prevents abuse of unneeded protocols.

---

## Step 8: DNS Settings

In the firewall I configured DNS servers:  

- **1.1.1.1** (public)  
- **10.1.1.50** (Active Directory server)  

![DNS setup](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/27.DNS%20Settings.png)

Enterprises often rely on internal AD DNS for domain services. Combining it with a public resolver ensures redundancy and control. Allowing users to set their own DNS is risky because it can bypass monitoring and security policies.

---

## Step 9: DHCP Settings

Next, I configured a DHCP pool on **PortA** (LAN).  

Settings:  
- Pool Name: DHCP-LAN-POOL  
- Lease Range: 10.1.1.151–10.1.1.199  
- Subnet Mask: /24  
- Use Interface IP as Gateway: Enabled  
- Conflict Detection: Enabled  
- Use Device DNS Settings: Enabled  

![Adding DHCP](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/28.Adding%20DHCP.png)

![General settings](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/29.Setting%20IP%20Address%20general%20settings.png)

![conflict](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/30.%20IP%20conflict%20and%20DNS.png)

Centralized DHCP ensures consistent, controlled addressing. Conflict detection prevents duplicate IPs, and using firewall DNS maintains security.

---

## Step 10: Confirm DHCP on Clients

I changed the PCs back to automatic IP assignment.  

![IP assignment](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/31.PC1%20DHCP.png)

On LAB-PC1 I confirmed it received an address from the pool.  

![IP address](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/32.PC1%20IP%20address.png)

Browsing still worked as expected.  

![browser check](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/33.PC%20check.png)

---

## Step 11: Firewall Lease Confirmation

On the firewall I confirmed both PCs had DHCP leases.  

![DHCP Lease](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/01.Rulesand%20Policies/34.DHCP%20Lease.png)

---

## Troubleshooting

- **Cannot browse after ping works:** Check DNS settings. If missing, add public or internal DNS.  
- **PC not receiving IP:** Verify DHCP pool range and conflict detection. Ensure PC NIC is set to DHCP.  
- **Rule not applying:** Confirm the host is included in the Source Networks. Misconfigured host groups often cause silent failures.  
- **Destination filtering not working:** Ensure FQDN host objects (e.g., YouTube) resolve correctly and firewall has DNS set up.  
- **No internet at all:** Double-check NAT masquerade is applied in the firewall rule.  

---

## Summary

In this lab we learned:  

- How to create firewall rules in Sophos and enforce them by source, destination, and service.  
- Why it is important to define hosts and groups in the firewall.  
- How NAT masquerade enables internet connectivity.  
- How DNS and DHCP integrate with firewall services for automation and consistency.  
- How rule enforcement can selectively allow or deny based on conditions.  

This wraps up the first Sophos Firewall lab. Next, I will explore **Web Policies**, where we will take filtering and control even further.  

Never stop learning!  

```
