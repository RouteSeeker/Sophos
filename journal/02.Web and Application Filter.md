# Sophos Firewall Lab 02: Web and Application Filter Policies

Hi there,  

In the previous lab, we covered firewall rules, DHCP, and DNS configuration on the Sophos XG Firewall. Those steps established the foundation for network access and connectivity. Today, we build on that work by introducing Web Filtering and Application Filtering, two powerful features that extend control beyond simple packet inspection into user behavior and application-level visibility.

This lab replicates a real-world scenario where administrators must balance usability with compliance. We will create custom policies, assign them to existing rules, and test their enforcement using lab clients LAB-PC1 and LAB-PC2.

This lab will go through:  
- Creating a web filter policy  
- Creating an application filter policy  
- Linking both policies into a firewall rule  
- Using the URL Category Lookup tool to confirm categorization  
- Testing the enforcement of policies on client PCs  
- Reviewing the logs to validate decisions  
- Troubleshooting what happens when something does not work  

Letâ€™s dive in.  

![Topology](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/01.Topology.png)

---

## Step 1: Creating a Web Filter Policy

I began by navigating to **Web > Policies** in the Sophos GUI. Here I created a **new Web Policy**.  

Inside the policy editor I added rules that block entire categories such as **gambling, Alcohol and Tobacco, and streaming media**.  

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/04.Creating%20Policies.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/05.Adding%20rule.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/06.Action.png)

  
Web policies are one of the pillars of NGFW control. Sophos uses a massive cloud-based categorization system to assign websites into categories such as Social Media, Streaming, Gambling, or Business. When you create a web filter policy you are not just blocking a single domain, but the entire class of websites within that category.  

This matters because websites constantly change domains, IP addresses, and hosting providers. Blocking them one by one is impossible. By tying enforcement to categories, administrators can keep their environments protected without constantly updating blacklists.  

In practice, organizations use different approaches: schools may block adult content and gaming, enterprises may block gambling and peer-to-peer, and regulated industries may block social media. The power of Sophos is that you can mix and match policies per user or per department.

Once I defined the categories to block, I saved the policy. 


---

## Step 2: Creating an Application Filter Policy

Next I navigated to **Applications > Policies**. I created a **new Application Filter Policy**.  

Inside this policy I selected categories and applications that I wanted to restrict. Examples included peer-to-peer applications, VPN clients, and certain streaming apps.  


![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/07.Adding%20Application%20Filter.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/08.Allow%20All%20Apps.png)

[!Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/09.Applications%20deny.png)

 
Application filters differ from web filters in that they look at the **application signature** and not just the website. For example, a user might be running Skype, Zoom, or a torrent client. Even if the web traffic is encrypted, Sophos can still detect the application by its behavioral fingerprint and block it.  

There are two approaches when designing application filters:  

- **Deny all and allow only what you need**: This is the most secure method. Only explicitly allowed apps will work. The drawback is that it requires planning and may initially block legitimate services until exceptions are added.  
- **Allow all and deny risky categories**: This is more lenient and user-friendly, but leaves a wider attack surface. Applications that are new or misclassified may still run until they are explicitly blocked.  

For high-security environments, deny-all with allow-lists is preferred. For general business environments, allow-all with deny-lists is often more practical. 

After selecting my categories and apps, I saved the policy.  

---

## Step 3: Linking Policies into a Firewall Rule

With both the web and application filters created, the next step was to enforce them. This happens through a firewall rule.  

I navigated to **Rules and Policies** and created a new firewall rule.  

- **Source Zone:** LAN  
- **Destination Zone:** WAN  
- **Source Networks/Devices:** LAB-PC1 and LAB-PC2  
- **Destination Networks:** Any  
- **Web Policy:** Selected the Web Filter created earlier  
- **Application Policy:** Selected the Application Filter created earlier  
- **Logging:** Enabled  

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/11.Applying%20Web%20Filter.png)

 
Sophos firewall rules work like a flow chart. Traffic comes in, matches a source zone and device, is checked against the destination, and then policies are applied. If you do not link a web or application policy here, they will not actually be enforced.  

By linking them, every packet from LAB-PC1 and LAB-PC2 to the WAN is now subject to category and application inspection. Enabling logging is equally critical, because without it you will not be able to verify what the firewall decided or troubleshoot issues. 

Once the settings were complete, I saved the firewall rule.  

---

## Step 4: Using the URL Category Lookup Tool

Before testing policies with client PCs, I used the **URL Category Lookup Tool** built into the Sophos GUI.  

I entered multiple domains such as:  
- `youtube.com`  
- `twitter.com`  
- Several gambling websites  

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/02.URL%20Category%20Lookup.png)

The tool returned the categories assigned by Sophos, confirming that YouTube was listed under streaming media, Twitter under Social Networking.  

This step is essential because all enforcement decisions rely on categorization. If a site is misclassified, then the filter may block or allow it unexpectedly. For example, if YouTube were misclassified as a "Search Engine," it would bypass a streaming block.  

By testing in advance, you ensure that your policy will have the desired effect. This also helps during troubleshooting and when explaining to end users why a site is blocked, the categorization can be shown directly.

---

## Step 5: Testing Web and Application Enforcement on Clients

With the policies and rule in place, I tested access directly from LAB-PC1 and LAB-PC2.  

The results were:  
- **YouTube:** Blocked by the Application Filter  
- **Gambling Sites:** Blocked by the Web Filter  
- **Yahoo:** Accessible, since it was not in any blocked category  

Before Filter
![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/10.testing%20youtube.png)

After Filter
![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/12.Social%20Networking%20blocked.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/14.Warning.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/14.Warning.png)
  
When a site like YouTube is blocked, it is not just a URL block. Sophos also examines the protocols being used. YouTube, for example, often uses the QUIC protocol which underpins HTTP/3.  

**What is QUIC?**  
QUIC is a transport protocol developed by Google that runs on UDP instead of TCP. It improves performance for streaming and web applications by reducing handshake latency and providing encryption by default. However, QUIC can bypass some forms of inspection because it encrypts more metadata and avoids traditional TCP-based firewalls.  

**Why block QUIC?**  
Blocking QUIC forces applications like YouTube to fall back to HTTPS over TCP, where Sophos inspection and filtering are more effective. This ensures policies are applied consistently.  

**Mitigation strategies:** While blocking QUIC improves security, it can break some services. The balance is to allow QUIC only for trusted applications where inspection is not critical, while keeping it blocked generally for unknown or risky traffic.  

---

## Step 6: Reviewing Firewall Logs

To validate enforcement, I checked the **Firewall Logs** in Sophos.  

The logs showed:  
- Source IP (the client PC)  
- Destination domain and category  
- Action (allow or deny)  
- Timestamp  

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/02.Web%20and%20Application%20Filter/15.Logs.png)

Logs are the most important verification step. They show exactly what the firewall decided and why. If a user claims they cannot access a site, you can cross-reference the log to confirm whether it was blocked, allowed, or matched the wrong policy. Logs also help identify misconfigurations such as missing filters or rule order problems.  

---

## Troubleshooting

If enforcement does not work as expected, here are the key checks:  

- Ensure the firewall rule has both the web and application policies applied.  
- Confirm the rule is positioned above more general allow rules.  
- Verify logging is enabled so you can see why traffic is being allowed or denied.  
- Use the **URL Category Lookup Tool** to check site classification.  
- Make sure the client PC is part of the source network or host group used in the rule.  

---

## Summary

In this lab we configured and tested:  

- A **Web Filter Policy** to block categories like gambling and streaming.  
- An **Application Filter Policy** to block applications and protocols like peer-to-peer and streaming.  
- A **Firewall Rule** that enforced both filters on LAB-PC1 and LAB-PC2.  
- The **URL Category Lookup Tool** to confirm how sites are classified before testing.  
- Real-world testing by blocking YouTube and gambling, while allowing Yahoo.  
- A deeper understanding of the **QUIC protocol**, why it matters, and why blocking it ensures stronger enforcement.  
- How to use **firewall logs** to confirm enforcement and troubleshoot.  

This wraps up Lab 02. Next week I will cover IDS and AD integration, where we will tune IDS signatures and integrate Active Directory for user based policies.

Never stop learning!  
