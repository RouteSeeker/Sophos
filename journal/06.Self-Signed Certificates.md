# Sophos Firewall Lab 06: Installing Self-Signed Certificates

Hi there,

Building up on last week, this week I will be installing self-signed certificates on our Sophos firewall and on domain clients. The immediate payoff is a green padlock in the browser when staff open the User Portal; the long-term win is re-using the same certificate infrastructure for TLS inspection.

**Why self-signed instead of Let’s Encrypt?**  

In a lab or air-gapped network you may not have outbound 80/443, and internal names like `sophos.lab.local` will never pass a public CA’s validation. Rolling your own CA gives you total control over lifetimes, SANs and revocation, and teaches the PKI workflow without spending money or opening firewall rules.

Browsers and OS trust stores treat the Sophos web UI as “untrusted” out of the box. Users quickly learn to click “Continue anyway” a habit we want to break before it spreads to phishing sites. A trusted root CA also lets us sign additional certificates (VPN, RDP, LDAPS) without buying a wildcard every year.

I will be using the same network setup as last time.

![ Network diagram](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/01.Topology.png)


---

## Step 1 – Log In and Notice the Browser Warning

Opening `https://10.1.1.200:8090` shows “Not secure” in the address bar.

![Firefox warning page on Sophos portal](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/02.insecure.png)  

**Why no padlock?**  

The firewall ships with a factory self-signed certificate. Because that cert was **not** signed by any CA the browser already trusts, Firefox/Chrome must flag it. The connection is still encrypted, but users cannot verify **who** they are talking to, perfect training ground for bad habits.

---

## Step 2 – Download the Enterprise CA Certificate

On the domain controller (already running Active Directory Certificate Services) open a browser to `http://localhost/certsrv/` and click **“Download a CA certificate, certificate chain, or CRL”**.

![cert service](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/03.Certificate_Authority.png)

![Download a CA certificate](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/04.certsrv.png)


**Why use the web-enroll site instead of copying from `C:\Windows\System32\CertSrv\CertEnroll`?**  
The web interface serves the **current CA certificate** in the format you need (DER, PEM, PKCS#7) without hunting through the file system. It also packages the **certificate chain** automatically, so you do not forget the intermediate if you ever add one later.

Choose **DER** encoding and click **“Download CA certificate”**.

![DER radio button selected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/05.Download_Cert.png 

Save the file and rename it to `MC-Server.cer`.

![Save-as dialog with MC-Server.cer](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/06.Rename_Cert.png)

**Why DER?**  
DER is a binary format that Windows’ certificate import wizard recognises natively; PEM would work but requires an extra “base-64 decode” step on some older MMC versions.

---

## Step 3 – Install the CA into Windows Trust Store

Right-click `MC-Server.cer` > **Install Certificate**.

![Install Certificate](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/07.install%20cert.png) 


![Import Wizard welcome](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/08.install%20cert.png)


Choose **Current User** (or Machine if you have local admin), then **“Place all certificates in the following store”**, browse to **Trusted Root Certification Authorities**, and finish the wizard.

![“Current User” radio selected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/09.user.png)


![ Browse to Trusted Root CA store](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/10.import.png)


![Completing-the-wizard summary](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/11.Trusted_Root.png) 


![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/12.Finish.png)


![warning](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/13.Warning.png)


**What did we just do?**  
We told Windows, “Any certificate signed by MC-Server is trusted.” From now on **Edge, Chrome, Internet Explorer** and any .NET application will accept portals or LDAPS endpoints that present a cert chained to MC-Server—no more red address bar.

---

## Step 4 – Verify with MMC (Optional but Educational)

Press **Win+R**, type `mmc`, hit Enter.

![mmc](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/14.mmc.png)

Under **File > Add/Remove Snap-in** add **Certificates (Current User)**.

![ MMC Add Snap-in dialog](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/15.Add-Snap-in.png)


Drill down to **Trusted Root Certification Authorities > Certificates**, right-click **All Tasks > Import**, and import `MC-Server.cer` again (reinforces the learning path).

![Certificates snap-in highlighted](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/16.Certificates.png)


![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/18.Import.png)


![browse](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/19.Browse.png)


![mc-server](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/20.Cert.png)


![location](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/21.location.png)


![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/22.Finish.png)


**Why bother with MMC if the wizard already worked?**  
MMC gives you a **second path** you can use later for **machine-wide** imports or for **Group Policy** modelling. It also shows **thumbprints, expiry dates and certificate paths**—handy when troubleshooting chain errors.

---

## Step 5 – Import the Same Root into Firefox

Firefox uses its **own certificate store**. Open **Firefox > Settings > Privacy & Security > View Certificates > Authorities**, click **Import**, select `MC-Server.cer`, and tick both **“Trust this CA to identify websites”** and **“Trust this CA to identify email users”**.

![Firefox certificate manager](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/23.Firefox.png)

![settings](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/24.Security.png)


![view cert](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/25.View_Cert.png)


![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/26.Import.png)


![mc-cert](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/27.MC_Cert.png)


![trust](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/28.Trust.png)
**Why two checkboxes?**  
The first enables SSL/TLS trust (our immediate goal); the second allows the root to sign **S/MIME** certificates if you later decide to encrypt internal email. Leaving them unchecked means Firefox will still warn even though Windows is happy, an inconsistency users hate.

---

## Step 6 – Create a Server Certificate **on** the Firewall

Back in the Sophos GUI go to **Protection > Certificates > Add**.

![add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/29.Add_Cert.png)

Fill in:
![details](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/30.Generate%20CSR%20and%20name.png)


![SAN](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/31.Subject%20Names%20Attribut.png)


![SAN](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/32.SAN.png)

**Why list both LAN and DMZ IPs?**  
The same certificate will be presented on **PortA (LAN)** and **PortC (DMZ)**. If you forget a SAN, browsers that connect via the missing IP will throw `ERR_CERT_COMMON_NAME_INVALID` even though the hostname is correct.

Under **Advanced > Certificate ID** select **IP address** and enter `10.1.1.200`, then click **Generate & Download**.  

![Advanced settings with IP selected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/33.Advanced.png) 

Save the CSR text to clipboard we will sign it with the AD CA next.

![Download](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/34.Download.png)

![copy](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/35.copytoclipboard.png)

---

## Step 7 – Sign the CSR with the Enterprise CA

Return to the AD server web-enroll page (`http://localhost/certsrv`) and click **“Request a certificate > advanced certificate request”**.

![Request a cert](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/36.requestcert.png) 


![Advanced request link](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/37.Advanced.png)

Choose **“Submit a certificate request by using a base-64-encoded PKCS #10 …”**, paste the **CSR text** you copied from Sophos, select **Web Server** template, and click **Submit**.

![submit](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/38.Submit%20request.png) 


![Base-64 request box with CSR pasted](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/39.PasteCert.png)


On the next page choose **Base 64 encoded**, click **Download certificate**, and rename the file to `certcsr.cer`.

![Download Base-64 certificate button](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/40.Install_Cert.png)


**Why the Web Server template?**  
It includes **Server Authentication** enhanced key usage and allows **IP addresses** in the SAN field—exactly what IKEv2 and HTTPS require. The default **User** template would fail because it lacks `serverAuth`.

---

## Step 8 – Upload the Signed Certificate to Sophos

Use **WinSCP** (or any SCP client) to copy `certcsr.cer` from the AD server into `/tmp` on the firewall.

![WinSCP drag-and-drop](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/42.WinSCP.png) 


Back in the GUI click **Import**, choose `blocktopuscsr` and `blocktopuscsr.tar.gz`, and finish the wizard.  

![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/44.Import.png)


![importfile](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/45.ImportFile.png)


![import file](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/46.ImportCSR.png)


![download](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/47.ImportTheCert.png)


Under **Certificate Authorities** click **Add**, import `MC-Server.cer` again, name it `rseeker-DC-NBO1-CA`, and set **Use for**: Validation.

![Add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/48.Add_Cert_Authority.png)



![mc-server import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/50.MC_Server.png)


![save](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/51.Save.png)

**Why add the root **again** if we already trust it on clients?**  
Sophos needs the **public half** of the CA inside its **validation store** so it can verify **client certificates** during IKEv2 or HTTPS mutual auth. Without this step the firewall would reply “unknown CA” even though Windows is happy.

---

## Step 9 – Activate the Certificate for Web Services

Go to **Administration > Admin & User Settings**, scroll to **Certificate**, click **Use IP of first internal interface**, then **Check Settings**.

![certificate](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/52.certificateSettings.png)

You should see two green ticks:
- IP address matches selected certificate  
- IP address is an internal interface IP address

![Redirect hostname check with two green ticks](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/53.Redirect_Check.png)


**What just happened?**  
The firewall rewrites its nginx config to bind `ourcert` on port 4444 (User Portal) and port 4443 (VPN Portal). Any bookmark that points to `https://10.1.1.200:4444` now serves a certificate **signed by MC-Server**, so browsers trust it immediately.

---

## Step 10 – Browser Reality Check

Reload `https://10.1.1.200:4444`—the padlock is now green and the certificate path shows.

![Firefox padlock details showing trusted path](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/54.Encrypted.png)


**If you still see a warning** double-check:
- The **common name or SAN** matches the **IP/hostname** you typed.  
- The **system clock** is within the validity window.  
- Firefox was restarted (it caches untrusted status aggressively).

---

## Step 11 – Push the Root to Every Domain PC with Group Policy

Open **Group Policy Management**, create a new GPO named **HTTPS-Sophos**, and edit it.

![HTTPS Sophos](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/56.HTTPS_SophosGPS.png)

Navigate to:
**Computer Configuration > Policies > Windows Settings > Security Settings > Public Key Policies > Trusted Root Certification Authorities**

![navigate](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/57.TrustedRoot.png)

Right-click **Import**, browse to `MC-Server.cer`, and finish the wizard.

![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/58.MC_ServerCert.png)



![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/59.Finish.png)

Link the GPO to the domain root (or a specific OU), open an elevated command prompt, and run:

```
gpupdate /force
```
![gpupdate](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/60.GPupdate.png)

![update](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/63.GPUpdate%20Force.png)

Log on to **PC2** Firefox now show the green padlock **without any manual install**.

![success](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/64.Test.png) 


**Why use a GPO instead of manual installs?**  
One file, one policy, unlimited machines. When the certificate eventually expires you replace the GPO content and every domain member picks up the new root at next policy refresh no deskside visits, no help-desk tickets.

---

## Step 12 – Push the Same Root into Firefox via ADMX Templates (optional)

Download the **official Firefox ADMX/ADML** templates from Mozilla’s GitHub release page.

![copy](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/65.%20Download%20ZIP.png)



Copy:
- `firefox.admx` and `mozilla.admx` → `\\dc\SYSVOL\domain\Policies\PolicyDefinitions\`  
- `firefox.adml` and `mozilla.adml` → `\\dc\SYSVOL\domain\Policies\PolicyDefinitions\en-US\`

![File copy into PolicyDefinitions](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/67.Copy%20ADMX%20from%20the%20Policy%20template.png)


![paste](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/68.Paste%20into%20policy%20directory.png)


![copy](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/69.Copy%20adml.png)


![paste](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/70.Paste%20into%20en-US%20directory.png)

Under:
**Computer Configuration > Policies > Mozilla > Firefox > Certificates > Install Certificates**

![New GPO](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/66.New%20Firefox%20GPO.png))


![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/71.Install%20cert%20of%20mozilla%20GPO.png)


![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/72.Enable%20then%20show.png)


![mc-server](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/73.mc-server.cer.png)


![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/74.Apply.png)


Create a second GPO called **HTTPS Sophos 2**.


Under **User Configuration > Preferences > Windows Settings > Files** create two file preference items:

![GPO setup](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/76.File%20Windows%20GPO%20setting.png)

| Source | Destination |
|--------|-------------|
| `\\SYSVOL\MC-Server.cer` | `%USERPROFILE%\AppData\Local\Mozilla\Certificates\MC-Server.cer` |
| `\\SYSVOL\MC-Server.cer` | `%USERPROFILE%\AppData\Roaming\Mozilla\Certificates\MC-Server.cer` |


![File preference item inside GPO](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/77.Local.png)



![file ](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/78.Roaming.png)

Run `gpupdate /force` again

![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/07.Self%20Signed%20Certificates/79.GPUpdate%20Force.png)

**Why two file copies?**  
Firefox reads the **profile-specific** (`AppData\Roaming`) and **installation-wide** (`AppData\Local`) certificate folders. Covering both ensures the root is trusted even if a user launches Firefox with a **fresh profile**.

---

## Summary

In this lab we:

- Downloaded the **enterprise CA certificate** from AD CS and installed it into **Windows**, **MMC**, and **Firefox** trust stores.  
- Generated a **server certificate CSR on the firewall**, signed it with the AD CA, and imported the finished certificate back into Sophos.  
- Activated the new certificate for **HTTPS admin and user portals**, eliminating the browser “Not secure” warning.  
- Used **Group Policy** to push the root CA to every domain PC and **Firefox ADMX templates** to cover Mozilla’s separate trust store—no manual clicks required.

Never stop learning!
