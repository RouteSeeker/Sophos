# Sophos Firewall Lab 04: Client Authentication and SSL VPN

Hi there,

Building up on last week, this week I am doing client authentication where we will be downloading an exe to enable clients to authenticate without having to use the browser. After that I will be setting up Remote Access SSL VPN.

**Why bother with the Authentication Agent?**  
Browser-based captive portals are fine for guests, but they break non-HTTP traffic (ping, SSH, RDP) and time out constantly. The lightweight Windows agent keeps the user session alive at the kernel layer, so every packet is stamped with the correct AD identity even if the browser is closed. The result: seamless single sign-on, stable quotas, and logs that show **usernames** instead of bare IP addresses.

**Why SSL VPN instead of IPsec this week?**  
SSL VPN rides on TCP 443, so it passes through every hotel, airport and 4G hotspot on the planet without extra NAT-T tweaks. It also inherits the same AD authentication and web/application filters we already built, giving remote users the **exact** same security posture they have inside the office.

Let’s implement both.

---

### Lab Setup 
- PortA: LAN 10.1.1.0/24  
- PortB: WAN 192.168.10.0/24  
- PortC: DMZ 172.16.0.0/24  
- LAB-PC1 on LAN  
- AD Server 2019 @ 10.1.1.50 (already joined last week)

---

## Step 1 – Accessing the User Portal

Open a browser to `https://10.1.1.200:4444` and log in with your firewall admin account.  
On the landing page click **“Access the User Portal”** (you will be asked to re-authenticate).

Inside the portal menu click **Download Client > Windows EXE**.

![User Portal download section](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/02.Accessing%20User%20portal.png)

![User Portal download section highlighting Windows EXE link](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/04.Download%20client.png) 

The portal automatically serves the correct agent build that matches your firmware version, pre-baked with the firewall’s certificate thumbprint. Downloading anywhere else would force you to import the CA manually and trust it later.

---

## Step 2 – Installing the Client Authentication Agent

Launch `SophosConnectAuthAgent.exe`.  
Wizard steps:

1. Welcome page – click **Next**.

![Setup wizard](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/05.Agent%20setup%201.png)

2. Tick **“Run Client Authentication Agent”** – Finish.

![“Run Client Authentication Agent” checkbox enabled](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/06.Agent%20setup%202.png) 

**Why check the box?**  
This installs the service **and** starts it immediately. If you skip the tick you would have to hunt for the shortcut in Start Menu or `C:\Program Files (x86)\Sophos\Connect\AuthAgent` later.

---

## Step 3 – First Agent Connection

Look for the small shield icon in the system-tray (bottom right).  
Right-click it → **Connect**.

![connect](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/07.Connecting.png)

Enter the credentials of any AD user that is allowed by our firewall rule.

![username and password](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/08.setting%20password.png) 


**Why agent instead of browser?**  
The agent uses a lightweight **HTTPS POST** to the firewall’s port 4444, then keeps a **cookie jar** in the registry. No browser tabs, no captive portal redirects, no certificate warnings. Kernel drivers tag every outgoing packet with the user SID, so quotas and filters apply even for command-line tools like `ping` or `curl`.

---

## Step 4 – Testing Connectivity

Open Command Prompt and `ping 8.8.8.8`.  
Replies should return immediately, proving that **user identity** (not IP) is now whitelisted.

Open any browser and browse to `youtube.com` – the page loads without extra logins.

![Successful ping to 8.8.8.8](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/09.test%20ping.png)

![YouTube homepage loading after agent auth](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/10.google%20works.png)


**Why ping first?**  
ICMP is stateless and bypasses proxies. If ping works you have proven that the **identity session** is already active; if it fails you know the problem is layer-3 and not a browser setting.

---

## Step 5 – Confirm on Sophos

Back on the firewall go to **Diagnostics > Current Activities**.  
You will see an entry:

```
User: toms
Client Type: Authentication-Agent  
IP: 10.1.1.152  
Logged-in: yes
```

![Current Activities grid showing Authentication-Agent client type](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/11.Checking%20client%20type.png)  

 
This proves the agent is **actively heart-beating** every 60 seconds. If the tray icon crashes or the laptop sleeps, this entry disappears and the user falls back to “unknown” – handy for troubleshooting disappearing quotas.

---

## Step 6 – Create Local Group for SSL VPN Users

Navigate to **Authentication > Groups > Add**.  
Group Name: `SSL-VPN-Group`  
Type: Normal

Save.

![Add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/12.Add%20new%20SSL%20Group.png)

![Group Name](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/13.Group%20names%20and%20policies.png)

Still under **Authentication > Users > Add** create:

Username: `VPNUser1`  
Password: ********  
Email: `vpnuser1@rseeker.local`  
Member of: `SSL-VPN-Group`

![Adding users](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/14.VPNUser%20add.png)  


**Why create a local group when we already have AD?**  
Two reasons:  
1. You may need **emergency accounts** that work even if AD is down.  
2. You can apply **different tunnel profiles** (routes, quotas, subnets) to local vs AD groups for layered security.

---

## Step 7 – Define VPN Client IP Pool

Go to **Hosts and Services > IP Host > Add**.

Name: `SSL-VPN-Client-Pool`  
Type: Network  
Network Address: `192.168.3.0 /24`  
(We will hand addresses from this range to incoming tunnels.)

![Add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/15.Adding%20VPN%20clients.png)

![IP host object for 192.168.3.0/24](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/16.Creating%20IP%20range.png)


**Why a dedicated subnet?**  
Keeping VPN users in their own RFC-1918 block makes it trivial to write firewall rules that **only** apply to remote traffic, and keeps routing tables clean.

---

## Step 8 – Create SSL VPN Policy

**Remote Access VPN > SSL VPN (tab) > Add**.

**General Settings**  
Profile Name: `SSL-VPN-Policy`  
Members: `Administrators`, `Sales`, `SSL-VPN-Group` (multi-select)

![Add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/17.Creating%20VPN%20Policy.png)

![policy](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/18.Remote%20Access%20name.png)

**Tunnel Access**  
Permitted Network Resources: add `Net-Users` (the LAN subnet 10.1.1.0/24 we created in Lab 01)

![Tunnel access list showing Net-Users](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/19.Split%20Tuneling.png) 


**Explanation**  
Only the groups listed above will **receive the ovpn file** when they log into the VPN portal. Permitted networks control which **destinations** the client is allowed to route across the tunnel; everything else will use the client’s local gateway (split-tunnel).

---

## Step 9 – Add Authentication Back-Ends

Still inside the SSL VPN profile open **Authentication**.

Move `AD-Server` into **Selected Authentication Servers**.

![Authenication](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/20.Adding%20authentication.png) 

Scroll down to **SSL VPN Authentication Methods** and also tick `AD-Server`.

![SSL Authentication](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/21.verifying%20authentication.png)  

Finally open **Device Access > Administration**.

Under **WAN** tick **VPN Portal**  
Under **LAN & WAN** tick **User Portal**

![Administration](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/22.Adding%20SSL%20VPN%20service.png) 


**Why enable both portals?**  
The **User Portal** (port 4444) is where users download the ovpn file and agent installers. The **VPN Portal** (port 8443) is the actual SSL VPN termination point. Checking them under **Device Access** tells the firewall to **listen** on those ports; without this step the sockets are closed and connections will reset.

---

## Step 10 – Global SSL VPN Settings

**Remote Access VPN > SSL VPN > Global Settings** (cog icon).

SSL Server Certificate: choose **ApplianceCertificate** (the self-signed cert created at first install).  
IPv4 Lease Pool: select `SSL-VPN-Client-Pool` (192.168.3.0/24).  
Leave cipher strength at **AES-256-GCM** and compression **enabled**.

![Settings](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/24.SSL%20Global%20Settings.png)

![Global settings](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/25.IP%20settings.png)


**Why the self-signed cert is fine for labs**  
It already contains the firewall’s public RSA key. Clients will warn once, then remember the thumbprint. In production swap it for a **public CA** or **Let’s Encrypt** cert to avoid browser scares.

---

## Step 11 – Firewall Rule for VPN Traffic

**Rules and Policies > Add**.

Rule Name: `VPN-Access`  
Source Zone: `VPN`  
Source Networks: `SSL-VPN-Client`  
Destination Zone: `LAN`  
Destination Networks: `Net-Users`  
Services: `Any`  
Tick **Match known users** and select group `SSL-VPN-Group`.

![New Rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/26.Creating%20FW%20Policy%201.png)

![finishing](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/27.Creating%20FW%20Policy%202.png)

**Reason for every knob**  
- **VPN zone** is automatically created when SSL VPN is enabled; it represents **tun0** interface.  
- **Match known users** enforces that only **authenticated** members of `SSL-VPN-Group` can use the rule, stopping someone who merely steals the ovpn file but lacks credentials.

---

## Step 12 – Download and Install SSL VPN Client from Off-Laptop

Take any PC **outside** the lab.  
Browse to `https://<WAN-IP>:8443` → VPN Portal.

![VPN CLient](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/28.VPN%20Portal.png)

Click **Download SSL VPN Client for Windows** and **Download Configuration**.

![Client VPN](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/29.download%20vpn%20client.png)

Install the client, launch it, click **Import Connection** and point to the `.ovpn` file you just saved.

![Import connection](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/31.Import.png)

Enter `username` + password → **Connect**.

![Connect](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/33.Connect.png)

![Username and Password](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/34.usernamenapassword.png)

![connected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/35.VPN%20connected.png)

**Why import instead of manual setup?**  
The ovpn file contains the **static CA**, **TLS-auth key**, **cipher list**, and **split-include routes**. Typing these by hand is error-prone and leaks secrets into clipboard history.

---

## Step 13 – Confirm Remote User on Sophos

Back on the firewall **Current Activities** now shows:

```
User: VPNUser1  
IP: 192.168.30.2  
Client Type: SSL VPN  
Bytes In/Out: 12.3 MB / 4.1 MB
```

![Current Activities with SSL VPN entry](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/36.remote%20users.png)

From the remote PC open **Remote Desktop** and connect to `10.1.1.152`
The RDP session opens, proving **LAN reachability** across the tunnel.

![RDP](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/37.rdp%20to%20pc.png)

![success](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/05.Client%20Auth%20and%20SSL%20VPN/39.success.png)

**Why RDP as a final test?**  
It generates **long-lived TCP streams** and **large packets**. If MTU or fragmentation is mis-configured, RDP will freeze long before a simple ping fails, so it is the ultimate “real-world” validation.

---

## Summary

In this lab we:

- Deployed the **Sophos Client Authentication Agent** to give domain PCs seamless, browser-free identity that survives reboots and sleep.
- Created a **local SSL-VPN-Group** and mixed it with AD groups for flexible, fail-safe authentication.
- Built a **dedicated IP pool** (192.168.3.0/24) and **SSL VPN profile** that pushes routes and settings automatically.
- Opened **Device Access** sockets and wrote a **firewall rule** that only allows **authenticated** VPN users into the LAN.
- Validated the entire pipeline from an **external laptop**, confirming **tunnel establishment**, **user logging**, and **layer-7 reachability** via Remote Desktop.

Next week we will layer on **IPsec VPN** to compare policy-based versus route-based tunnels, and to provide always-up site-to-site connectivity between branch offices.

Never stop learning!
```
