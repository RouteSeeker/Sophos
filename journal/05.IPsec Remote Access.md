## Sophos Firewall Lab 05: IPsec Remote Access VPN

Hi there,

Building up on last week, this week I am doing client authentication via IPsec instead of SSL VPN authentication. This will be a fairly short lab which is building on last week’s topic.

**Why bother with IPsec when SSL VPN already works?**  
SSL VPN rides on TCP 443, so it punches through most hotspots, but that same trait makes it **susceptible to TCP meltdown** on lossy networks and harder to shape with QoS. IPsec uses **UDP 500/4500**, offers **kernel-level performance**, and supports **MOBIKE**, letting a laptop switch networks without dropping the tunnel. Plus, native IKEv2 clients are baked into Windows, macOS, iOS and Android **zero third-party software** to deploy.

Let’s add a parallel IPsec remote-access lane and let users pick whichever transport suits their day.

---

![Topology](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/01.topology.PNG)

### Lab Setup (unchanged)
- PortA: LAN 10.1.1.0/24  
- PortB: WAN 192.168.10.0/24  
- PortC: DMZ 172.16.0.0/24  
- LAB-PC1 & LAB-PC2 on LAN
- Remote Access PC  
- AD Server 10.1.1.50
---

## Step 1 – Enable IPsec Listening Interfaces

Navigate to **Device Access &gt; Administration**.

Tick:
- **IPsec** under WAN  
- **VPN Portal** under WAN and VPN  
- **User Portal** under LAN, WAN and DMZ

![Device Access grid with IPsec and portal boxes checked](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/02.Device%20Access.png)  

**Why open all three?**  
- **IPsec (UDP 500/4500)** must be reachable from the Internet or the tunnel never forms.  
- **VPN Portal (TCP 8443)** serves the `.spc` configuration file that Windows imports.  
- **User Portal (TCP 4444)** lets users download the Sophos Connect client itself.  
Leaving any of these unchecked silently drops packets at the kernel, so the rule-of-thumb is “check it now, tighten it later.”

---

## Step 2 – Create IPsec Client IP Pool

Go to **Hosts and Services &gt; IP Host &gt; Add**.

Name: `SSL-VPN-IPsec`  
Type: Network  
Network Address: `192.168.5.0 /24`

![IP host object for 192.168.5.0/24](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/03.IP_Host.png)  


Splitting pools lets you write **distinct firewall rules** (different quotas, DNS or IPS profiles) for SSL and IPsec users even though both terminate on the same box. It also keeps the routing table tidy—Sophos automatically adds a static route pointing to the pool once the first tunnel comes up.

---

## Step 3 – Create the IPsec Firewall Rule

**Rules and Policies &gt; Add**.

Rule Name: `VPN-Access`  
Source Zone: `VPN`  
Source Networks: `RA-VPN-IPsec-Pool`  
Destination Zone: `LAN`  
Destination Networks: `Any`  
Services: `Any`  
Tick **Match known users** and add both **AD Server** members and the local **RA-VPN-Group** we created last week.

![IPsec rule showing source pool and user groups](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/04.Rules_1.png) 

![IPsec rule showing source pool and user groups](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/05.Rules_2.png)

 
The pool only proves **where** the packet came from; the user check proves **who** sent it. If an attacker somehow hijacks a lease (e.g., via spoofed IKE_AUTH), they still can’t pass traffic without passing AD authentication first—defence in depth.

---

## Step 4 – Configure the Remote Access IPsec Tunnel

**Remote Access VPN &gt; IPsec &gt; Add**.

General:
- **Enable Remote Access VPN**: tick  
- **Interface**: PortB (192.168.10.200)  
- **IPsec Profile**: DefaultRemoteAccess  
- **Authentication**: Preshared Key → enter `password` twice

Allowed Users & Groups:
- `AD Users`, `SSL-VPN Group`

![IPsec profile general settings](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/06.IPSEC_Config_1.png) 


Client Information:
- **Lease Range**: 192.168.5.20 – 192.168.5.40  
- **DNS1**: 10.1.1.200 (firewall)  
- **DNS2**: 10.1.1.50 (AD)

![Client lease and DNS boxes](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/07.IPSEC_Config_2.png)

Advanced:
- **Idle Time**: 300 s (default)  
- **Use as Default Gateway**: untick (split-tunnel)  
- **Permitted Network Resources**: `Net-Users` (10.1.1.0/24)  
- **Allow users to save username and password**: tick

Click **Apply**, then **Export Connection** to download the `.spc` file.

[Advanced split-tunnel options](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/08.IPSEC_Config_3.png)


**Why split-tunnel instead of full-tunnel?**  
Full-tunnel forces even YouTube traffic through the firewall, great for inspection, bad for user experience on slow links. Split-tunnel sends **only corporate ranges** (Net-Users) across the tunnel; Internet traffic exits the local ISP, keeping latency low and conserving WAN bandwidth at HQ.

---

## Step 5 – Install the Sophos Connect Client on the Remote PC

From the same off-network laptop browse to `https://&lt;WAN-IP&gt;:4444` → User Portal.

Download **Sophos Connect for Windows** and the `.spc` configuration file we just exported.

![User Portal showing IPsec download links](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/10.VPN%20Portal.png) 

![vpn client](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/11.VPN_Client.png)

Run the installer, no reboot required.

Open **Sophos Connect**, click **Import Connection**, choose the `.spc` file.

![Import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/12.Import_Configs.png)

![import](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/13.File.png)

![imported](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/14.IPsec_NBO%20imported.png)

Enter `usename` + `password` and click **Sign in**.

![sign in](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/15.login.png)

Status changes to **Connected** and shows **VPN Type: IPsec**.

![Client status window showing IPsec connected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/16.Connected.png) 


**Why bother with the .spc file?**  
It bundles the **preshared key**, **CA certificate**, **IKE cipher suites**, and **split-tunnel routes** into one signed XML blob. Users cannot accidentally weaken encryption or mistype the gateway address; the admin controls every parameter.

---

## Step 6 – Test and Confirm

From the remote PC `ping 10.1.1.153` (LAB-PC1).  
Replies return, proving LAN reachability.

![ping test](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/17.ping_test.png)


On the firewall open **Diagnostics &gt; Current Activities &gt; IPsec Connections**.  
You will see:

![IPsec connection grid](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/18.live_Users.png) 

Finally, check **Log Viewer > VPN**.  
An entry shows:

![VPN logs](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/06.IPsec%20Remote%20Acess/19.logs.png)


**Why triple-check ping, current activities and logs?**  
Ping proves **data plane**, Current Activities proves **user plane**, and the log proves **control plane**. If any one of the three fails you know exactly which subsystem to troubleshoot—no guesswork.

---

## Summary

In this lab we:

- Enabled **IPsec listening sockets** on WAN and opened the necessary portals for file download.
- Created a **dedicated 192.168.5.0/24 pool** and **IPsec firewall rule** that enforces AD authentication before LAN access.
- Built an **IKEv2 remote-access profile** with **preshared-key auth**, **split-tunnel DNS**, and **lease range** exported as a signed `.spc` file.
- Installed **Sophos Connect** on an off-net laptop, imported the profile, and established a **MOBIKE-capable tunnel** without manual crypto settings.
- Validated **data, user and control planes** via ping, Current Activities and VPN logs—confirming the tunnel is ready for production use.

Next week we will dive into **certificate-based IPsec**, where we generate our own private CA and retire the preshared key for good,boosting security.

Never stop learning!
