# Sophos Firewall Lab 03: IPS, ATP and AD Integration

Hi there,

Building up from last week’s lab, this week we add three major pillars of next-gen control: **Intrusion Prevention System (IPS)**, **Active Threat Response (ATP)**, and **Active Directory (AD) integration**.  
These features move us from simple allow/deny rules into real-time attack mitigation, cloud-threat intelligence, and user-based policy enforcement.

**Why IPS?**  
IPS inspects every packet’s payload against a constantly updated signature database. It catches exploits, shell-code, buffer-overflows and malware command-and-control (C2) that a plain firewall rule would miss. Turning IPS on is the difference between “allow port 80” and “allow port 80 **only if it does not contain a SQL-injection attack**.”

**Why ATP?**  
While IPS uses signatures, ATP uses **live cloud reputation**. IPs, domains and file hashes are checked in real time against Sophos X-Ops threat feeds. A brand-new phishing site that was registered five minutes ago is **already blocked** without waiting for a signature push.

**Why AD integration?**  
IP addresses are a poor way to define policy. Users move, DHCP leases change, and shared PCs exist. Binding rules to **AD users & groups** gives you **identity-aware security**: the same laptop gets different browsing quotas, web filters and IPS profiles depending on who is logged in.

Let’s implement all three.

---

### Lab Setup (unchanged)
- PortA: LAN 10.1.1.0/24  
- PortB: WAN 192.168.10.0/24  
- PortC: DMZ 172.16.0.0/24  
- LAB-PC1 & LAB-PC2 on LAN  
- Windows Server 2019 AD @ 10.1.1.50 (will be used in Step 5)

![Topology](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/01.Topology.png)

---

## Step 1 – Enable IPS and Clone Default Signatures

Navigate to **Protect > Intrusion Prevention > IPS Policies**.  
Toggle the master **IPS Protection** switch to ON.

![IPS master toggle enabled](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/02.Setting%20IPS%20signatures.png)


Click **Add** and create a new policy.  
Name: `IPS-LAN-WAN`  
Template: clone **“LAN to WAN”** default rules.

**Why clone?**  
Cloning gives you a working baseline instead of starting empty. You keep the proven “allow HTTP/HTTPS” exceptions while adding your own malware rules on top—reduces false positives and saves hours of tuning.

![Clone default LAN-to-WAN rule-set](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/03.IPS%20setup.png)

![Custom malware-backdoor signature definition](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/04.Edit_IPS.png)


---

## Step 2 – Add Custom Malware-Backdoor Rule

Edit the newly cloned policy.  
Inside the signature list click **Add Custom Rule**.

| Field        | Value |
|--------------|-------|
| Rule Name    | `Malware-backdoor` |
| Categories   | malware, backdoor |
| Severity     | Major, Critical, Moderate |
| Platform     | Windows, macOS |
| Target       | Client |
| Action       | Drop Packet |

**What we just did**  
We told Sophos to drop any packet whose payload matches **Snort/Suricata signatures** tagged “malware” or “backdoor” **and** rated major or higher. By limiting to client-side signatures we avoid dropping server-side exploits that we might actually want to catch later in the DMZ. Dropping the packet **silently** prevents the attacker from learning anything about our defenses.


![Custom malware-backdoor signature definition](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/05.adding%20new%20IPS.png)

---

## Step 3 – Attach IPS Policy to Firewall Rule

Go to **Rules and Policies > [your existing LAN-to-WAN rule] > Edit**.  
Scroll to **Detect and Prevent Exploits > Other Security Features**.  
Select the new `IPS-LAN-WAN` policy and **Save**.

![IPS policy linked inside firewall rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/06.Adding%20IPS.png)

---

## Step 4 – Activate Active Threat Response (ATP)

Open **Protection > Advanced Threat > Active Threat Response**.  
Enable **Sophos X-Ops Threat Feeds** and set action to **Log & Drop**.  
Under **Advanced Settings** tick **Inspect All Content** and click **Apply**.

![X-Ops threat feeds enabled with Log & Drop](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/07.ATP.png)

---

## Step 5 – Test IPS + ATP Together

From LAB-PC1 browse to a **known-bad IOC domain** (e.g. `http://ammyy[.]com` – old C2 used in labs).  
Page times out.  
Check **Log Viewer > Intrusion Prevention**.

Log entry shows:

```
Severity: Critical  
Signature: C2/Generic  
Action: Dropped  
Policy: IPS-LAN-WAN  
```

**Conclusion**: IPS signature caught the outbound C2 beacon **and** ATP cloud feed had already flagged the domain. Double-layer protection.

![Log showing dropped C2 malware event](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/03.IPS%20%26%20ATP/08.ATP%20test%20logs.png) 

---

## Step 6 – Add Active Directory Server

Navigate to **Authentication > Servers > Add**.

> **Why plain text in the lab?**
> LDAP over SSL (LDAPS) requires a CA certificate on the firewall and AD. In production always use **LDAPS** or STARTTLS to encrypt the bind credentials and prevent LLMNR poisoning attacks.

Click **Test Connection** – green check appears.

![Add AD-Server](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/02.Adding%20Authentication.png)

![Add AD-Server](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/03.AD_Setup.png)

![Test ](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/04.Test_Connection.png)

---

## Step 7 – Import AD Groups & Users

Still under **Authentication > Servers**, click **Import** on `AD-Server`.  
The wizard opens; select:

- `Domain Users`
- `Sales` (OU)

Finish the wizard.

![Before groups](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/05.Groups%20before.png)

![Import Users](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/07.import%20button.png)

![Wizard](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/08.start%20wizard.png)

![Import users](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/09.Importing%20groups.png)

![finish](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/11.completed.png)


Open **Authentication > Groups** – imported groups now listed.

![Imported AD groups visible in Sophos](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/12.groups%20after.png)

---

## Step 8 – Assign Surfing Quota to Sales Group

Edit the `Sales` group.  
Enable **Surfing Quota** > **Daily** > `10 minutes` > **Save**.

![Surfing quota](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/13.sales_quota.png) 

---

## Step 9 – Reference AD in Authentication Services

Go to **Authentication > Services > Firewall Authentication Methods**.  
Move `AD-Server` to the top of the list.

![Firewall](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/14.services%20ad.png)

Repeat for **User Portal Authentication Methods**.

![User Portal](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/15.user%20portal.png)

---

## Step 10 – Configure Captive Portal Behavior

Open **Authentication > Services > Web Authentication**.  
Tick:

- Show captive portal link  
- Show user portal link  
- Show web page after sign-in  
- Open web page in new browser window

![Captive portal options enabled](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/16.web%20authentication.png)

---

## Step 11 – Enable Identity-Based Rules

Edit the LAN-to-WAN firewall rule.  
Under **Source > Users**, enable:

- **Match known users**  
- **Use web authentication for unknown users**

![Identity options inside firewall rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/17.match%20known%20users.png)

---

## Step 12 – Test Known User (LAB-PC1)

Ping `8.8.8.8` – **Request timed out** .  
Open browser – captive portal appears.

![Identity options inside firewall rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/19.browsing%20without%20Captive%20Portal.png)

Enter `username` + password – authenticated.  
Browse to `youtube.com` – works.  
After **10 minutes** the quota page appears:

> “Periodic time over”

![Identity options inside firewall rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/20.after%20logging%20in.png)

Re-authentication fails until midnight – **quota enforced**.

![Quota exceeded message](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/21.user%20portal%20allocation.png)

![Quota exceeded message](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/22.user%20portal%20test.png)

---

## Step 13 – Test Unknown User (LAB-PC2)

Set PC to DHCP.  
Ping `8.8.8.8` – still timed out.  
Browse – **page cannot be displayed**, no captive portal yet.

![Quota exceeded message](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/23.uknown%20user%20ping.png)

![Browser](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/24.Uknown%20user%20browser.png)

**Root cause**: PC has no DNS.  
The browser cannot resolve the captive-portal FQDN (`10.1.1.200:8090`) so the redirect never happens.

---

## Step 14 – Create DNS Allow Rule

Add new firewall rule **DNS-LAN-WAN**:

| Field       | Value |
|-------------|-------|
| Source Zone | LAN   |
| Dest Zone   | WAN   |
| Services    | DNS (UDP 53) |
| NAT         | MASQ |

> **Why DNS must be allowed before auth?**  
> The captive portal is delivered via HTTP redirect. The browser first resolves the portal’s IP; if DNS is blocked the redirect fails and the user sees a generic timeout instead of the login page. Once DNS is open, the redirect works and the user can authenticate.

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/25.DNS-Rule-1%20setup.png)

![Placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/26.DNS-Rule-2%20setup.png)

---

## Step 15 – Retry Unknown User

Browse again – captive portal loads.  
Enter valid `username/password` – authenticated and browsing starts.  
Both users now visible under **Current Activities**.

![Current activities showing two AD-authenticated web sessions](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/27.portal%20unkown%20user.png)

![Working](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/28.browsing%20after%20logging%20in.png)

![Monitoring](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/04.AD%20Integration/29.live%20connections.png)

---

## Summary

In this lab we:

- Activated **IPS** with cloned LAN-to-WAN signatures and added a custom **malware-backdoor** rule that drops matching packets.
- Enabled **Active Threat Response** to block zero-day IOCs via Sophos X-Ops cloud feeds.
- Integrated **Active Directory** for user-based policy, imported groups, and enforced **surfing quotas**.
- Proved that **identity-aware rules** apply per-user, not per-IP, and that DNS must be allowed for captive-portal redirects to function.
- Verified enforcement through logs, quota expiry, and live AD session monitoring.

Next week we will deploy the **Sophos Client Authentication Agent** and configure **SSL VPN** to give remote users identity aware encrypted access, combining seamless AD logon with full UTM inspection before they ever hit the LAN

Never stop learning!
