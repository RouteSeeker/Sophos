# Sophos Firewall Lab 07: SSL-TLS Inspection

Hi there,

This week we turn the firewall into a man-in-the-middle, but the good kind.  
We will generate a subordinate CA certificate, enable SSL/TLS inspection, and watch encrypted traffic unfold in the logs while still respecting user privacy by excluding banking and health sites.

**Why decrypt at all?**  
HTTPS hides malware, hides command and control beacons, and hides phishing pages. If we never look inside, the next zero day walks straight through port 443. SSL/TLS inspection breaks the tunnel just long enough to scan payloads, then re encrypts with our own certificate so browsers never throw an error.

**Why a subordinate CA instead of a simple server cert?**  
A sub CA can mint on the fly certificates for any website (google.com, facebook.com, github.com) without pre generating thousands of files. Browsers trust the sub CA because we will chain it to the enterprise root we installed last week, seamless, scalable, and free.

Let us build the CA, create a decryption profile, and prove it works on live traffic.

---

![topology](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/01.Topology.png)

### Lab Setup (unchanged)
- PortA: LAN 10.1.1.0/24  
- PortB: WAN 192.168.10.0/24  
- PortC: DMZ 172.16.0.0/24  
- AD CS running on 10.1.1.50 (enterprise root CA already trusted)

---

## Step 1 – Generate a Subordinate CA CSR on the Firewall

**Protection > Certificates > Add**  
**Action**: Generate certificate signing request (CSR)

**Certificate Details**  
- Name: `SSL_TLS`  
- Key type: RSA 2048  
- Secure hash: SHA-256  

Fill in **Subject name attributes** (country, state, org, CN = `Sophos-SSL-SubCA`).

![Add](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/02.Adding%20new%20cert.png)


![names](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/03.Name.png)


![Subject attributes summary](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/04.Attributes.png)


**Why a subordinate CA and not a simple server certificate?**  
A **server certificate** can only represent **one** DNS name. SSL inspection must dynamically impersonate **every** site users visit (google.com, facebook.com, github.com). A **subordinate CA** is **trusted to sign other certificates**, so the firewall can mint a **unique cert per site** on-the-fly. Browsers accept these forged certs because the **sub-CA chains back to the enterprise root** we pushed via GPO last week so no errors, no user friction.

Click **Download** and copy the **base-64 CSR text** to clipboard.

![Download CSR button](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/05.DOwnload.png)  


---

## Step 2 – Sign the CSR with the Enterprise CA

On the AD server open a browser to `http://localhost/certsrv`  
Click **Request a certificate > Advanced certificate request**.

Choose **"Submit a certificate request by using a base-64-encoded CMC or PKCS #10 file"**, paste the **CSR**, and select **Subordinate Certification Authority** under **Certificate Template**.

![request cert](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/06.Request_Cert.png)


![advanced cert request](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/07.Advanced%20Cert.png) 


![placeholder for screenshot](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/08.Submit%20a%20cert.png) 


![submit cert](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/09.submit.png) 


**Why "Subordinate Certification Authority" and not "Web Server"?**  
The **Web Server** template lacks the **Certificate Signing** key usage bit. If we used it, the firewall could **not** sign additional certificates later, breaking the inspection engine. **Sub-CA** template explicitly grants **keyCertSign** and **cRLSign**, satisfying RFC 5280 requirements for a CA certificate.

After submission choose **Base 64 encoded**, download the certificate, and rename it to `TLS-SSL.cer`.

![ Base-64 download option](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/10.doqnload%20base64%20cert.png)
 

![Save-as dialog with TLS-SSL](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/11.rename%20to%20your%20liking.png) 


---

## Step 3 – Fetch the Private Key from the Firewall

Use **WinSCP** to log in to the Sophos box.  
Navigate to `/conf/certificate/csr` and copy the file `SSL_TLS.key` to your workstation.

![WinSCP window showing SSL_TLS.key](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/12.winscp%20ssl%20cert%20config.png)
 

**Why do we need the private key?**  
The CSR only contains the **public key**; the **sub-CA must possess the matching private key** to sign website certificates on-the-fly. The key never leaves the firewall in normal operation, but we need it once to **marry** the public certificate we just received from AD CS.

---

## Step 4 – Upload the Signed Certificate into Sophos

Back on the firewall **Protection > Certificates**, select the pending `SSL_TLS` entry, click **Upload**, choose **Import certificate as**:  
- **Certificate and Certificate Authority**  
- **Name**: `SSL_TLS` (same as CSR)

Browse to `TLS-SSL.cer` and finish the wizard.

![Upload dialog](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/13.Import.png)

 
![File browse pointing to TLS-SSL.cer](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/14.Import.png) 
 

Still on the same certificate, click **Edit**, set **Certificate file format** to `.cer`, upload:
- **Certificate file**: `TLS-SSL.cer`  
- **Private key file**: `SSL_TLS.key` (from WinSCP)  
- **Passphrase**: gotten from the csr configs


![edit](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/15.Edit%20SSL.png)


![edit certs](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/16.cert%20details.png)


**What just happened?**  
Sophos now holds a **subordinate CA certificate** that chains to `MC-Server`. The **private key** is stored in the encrypted keystore and is used at runtime to mint **ephemeral certificates** for every HTTPS site users visit.

---

## Step 5 – Enable SSL/TLS Inspection Globally

**Rules and Policies > SSL/TLS Inspection Rules > SSL/TLS Inspection Settings**

Under **Re-sign RSA** and **Re-sign EC** select the `SSL_TLS` certificate we just imported. Leave the rest default.

![Global settings with SSL_TLS selected](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/17.SSL%20Settings.png) 

![Add rule dialog with Decrypt action](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/18.re-sign.png) 
 

Click **Add** to create a new rule:  
- **Name**: `My Decryption Inspection Rule`  
- **Action**: **Decrypt**  
- **Decryption Profile**: **Add**

![Add rule dialog with Decrypt action](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/19.Add.png)

 
![decryption profile](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/20.Create%20decryptionprofile.png)


![adding profile](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/21.decryption%20profile_1.png)


Name the profile `My Decryption Profile` and tick:  
- **Use CAs defined in SSL/TLS settings** (forces the firewall to use our sub-CA)  
Under **Non-decryption traffic** drop:  
- SSL 2.0, SSL 3.0, SSL compression  
- Connections that exceed cipher limit  
- Unrecognised cipher suites  

**Block action**: **Reject and notify**

![adding profile 2](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/22.decryption%20profile_2.png)


**Why drop obsolete protocols?**  
SSL 2.0/3.0 and compression are **insecure** (POODLE, CRIME). Refusing to re-sign them forces clients to negotiate TLS 1.2 or higher, raising the overall security posture without additional rules.

Back in the rule editor:  
- **Source**: LAN, Any networks, Any users  
- **Destination**: WAN, Any networks, Any services  
- **Security Features**: tick **Malware and content scanning**  
- **Web Policy**: select the **LAB policies** created in earlier labs

![decryption](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/23.Create%20decryptionprofile2.png)


![rule summary ](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/24.Scan%20HTTPS.png)


**Why tie the decryption rule to existing web and IPS policies?**  
Decrypting traffic is only half the job; we still need to **scan** the now plain HTTP stream for malware, apply **URL categories**, and run **IPS signatures**. Linking the same policy objects keeps management central and avoids duplicate rule maintenance.

---

## Step 6 – Test Full Decryption

From a client PC browse to `https://www.facebook.com` and to `https://www.chase.com`.

Facebook and Chase show a certificate **issued by “RSEEKER”**.

![facebook](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/25.success.png)  
 

![chase](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/26.Finance.png) 


**Privacy lesson learned**  
Decrypting **all** traffic raises legal and ethical issues. Banking and health sites are **explicitly excluded** in most corporate policies. We will create an exclusion rule next.

---

## Step 7 – Create a Privacy Friendly Exclusion Rule

**Rules and Policies > SSL/TLS Inspection Rules > Add**

- **Name**: `SSL Exclusions`  
- **Action**: **Don’t Decrypt**  
- **Decryption Profile**: **Maximum Compatibility** (allows old ciphers)  
- **Websites**: add **Financial Services** and **Health and Medicines** categories

![exclusion rule](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/27.SSL%20exclusion%20rule%201.png)

![websites](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/28.SSL%20exclusion%20rule%202.png)


Move the exclusion rule **above** the full decryption rule; Sophos evaluates rules top-down, so banking traffic hits “Don’t Decrypt” first and exits unchanged.

Revisit Chase the browser now shows the **original bank certificate**, proving the exclusion works.

![Chase padlock back to original issuer](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/29.No%20decryption.png)


---

## Step 8 – Confirm in the Logs

**Diagnostics > Logs > SSL/TLS Inspection**

You will see:
- `www.youtube.com` handled by **My Decryption Profile**  
- `www.chase.com` handled by **Maximum Compatibility**

![Log grid showing two different profiles](https://github.com/RouteSeeker/Sophos/blob/main/assets/screenshots/08.TLS-SSL%20Inspection/30.Logs.png)
 
**Why log at all?**  
Decryption is CPU intensive and privacy sensitive. Logs give you **per-site metrics** (bytes decrypted, cipher used, rule matched) and an audit trail if HR ever asks, “Who decrypted this health website yesterday?”

---

## Summary

In this lab we:

- Generated a **subordinate-CA CSR** on the firewall and had the **enterprise AD CS** sign it, giving us a certificate trusted by every domain PC.  
- Uploaded the sub CA **plus its private key** to Sophos, enabling **on-the-fly re-signing** of any HTTPS site.  
- Created a **global decryption profile** that drops obsolete protocols and linked it to existing **malware, IPS and web-filtering policies** no duplicate rules.  
- Added a **privacy-based exclusion** for financial and health categories, proving that decryption can be **selective and compliant**.  
- Verified everything in **live logs**, confirming YouTube is scanned while Chase Bank remains private.

Next week we will carve out a **DMZ segment**, place a public web server behind it, and use **Server Protection** policies to expose only the ports that should see the Internet while keeping the rest of the network invisible.

Never stop learning!
